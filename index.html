<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>麻雀 集計表</title>
<style>
body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  background:#f5f5f5;margin:0;padding:12px;
}
h1{text-align:center;margin:8px 0}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ccc;padding:6px;font-size:13px;text-align:center}
th{background:#eee}
input[type=number]{width:100%;box-sizing:border-box}

/* 操作バー */
#actionBar{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:6px;
  margin:10px 0;
}
#actionBar button{
  padding:8px;font-size:13px;
}

#historyArea{display:none;margin-top:10px}
#historyArea.fullscreen{
  position:fixed;inset:0;background:#fff;
  z-index:9999;padding:12px;overflow-y:auto;
}

@media(min-width:700px){
  #actionBar{grid-template-columns:repeat(4,1fr);}
}

/* タブレット用（iPad縦向きだけ） */
@media screen and (min-width: 700px) and (max-width: 1024px) and (orientation: portrait) {
  h1 {
    font-size: 50px;     /* タイトルをかなり大きく */
    margin: 16px 0;
  }

  body {
    font-size: 18px;
  }

  th, td {
    font-size: 18px;
    padding: 10px;
  }

  input {
    font-size: 18px;
  }

  button {
    font-size: 18px;
    padding: 10px 14px;
  }
}
</style>
</head>
<body>

<h1>麻雀 集計表</h1>

<table id="scoreTable">
<thead>
<tr>
<th>回戦</th>
<th><select class="player"></select></th>
<th><select class="player"></select></th>
<th><select class="player"></select></th>
<th><select class="player"></select></th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr><th>合計</th><th id="total0">0</th><th id="total1">0</th><th id="total2">0</th><th id="total3">0</th></tr>
<tr><th>順位</th><th id="rank0">-</th><th id="rank1">-</th><th id="rank2">-</th><th id="rank3">-</th></tr>
</tfoot>
</table>

<!-- 操作バー -->
<div id="actionBar">
  <button onclick="applyFavorite()">いつものメンバー</button>
  <button onclick="addRound()">回戦追加</button>
  <button onclick="saveGameResult()">保存</button>
  <button onclick="toggleHistory()">履歴</button>
  <button onclick="exportCSV()">CSV</button>
  <button onclick="resetData()">リセット</button>
</div>

<div id="historyArea">
<h2>対局履歴</h2>
<table>
<thead>
<tr><th>日時</th><th>プレイヤー</th><th>合計</th><th>順位</th><th>操作</th></tr>
</thead>
<tbody id="historyBody"></tbody>
</table>
<button onclick="toggleHistory()">戻る</button>
</div>

<script>
const FAVORITE_SET=["宮里","崎山","大屋","野里"];
const DEFAULT_MEMBERS=["宮里","崎山","大屋","野里","黒岩","牧志","西原","島袋","伊禮"];
const STORAGE_KEY="mahjong_score_data";
const HISTORY_KEY="mahjong_game_history";
const tbody=document.querySelector("#scoreTable tbody");

function initPlayerSelects(){
  document.querySelectorAll("select.player").forEach(sel=>{
    sel.innerHTML='<option value="">未選択</option>'+
      DEFAULT_MEMBERS.map(n=>`<option>${n}</option>`).join("");
    sel.onchange=saveData;
  });
}

function applyFavorite(){
  document.querySelectorAll("select.player").forEach((s,i)=>s.value=FAVORITE_SET[i]||"");
  saveData();
}

function addRound(values=["","","",""]){
  const tr=document.createElement("tr");
  tr.innerHTML="<td></td>"+values.map(v=>`<td><input type=number value="${v}"></td>`).join("");
  tbody.appendChild(tr);
  const inputs=[...tr.querySelectorAll("input")];

  function recalc(){
    inputs.forEach(i=>{
      if(i.dataset.auto){i.value="";i.readOnly=false;delete i.dataset.auto}
    });
    let sum=0,empty=[];
    inputs.forEach((i,idx)=>{
      if(i.value==="") empty.push(idx);
      else sum+=Number(i.value)||0;
    });
    if(empty.length===1){
      const i=inputs[empty[0]];
      i.value=-sum;i.readOnly=true;i.dataset.auto=1;
    }
    calculate();
  }
  inputs.forEach(i=>i.oninput=recalc);
  recalc(); updateRoundNames();
}

function updateRoundNames(){
  [...tbody.rows].forEach((r,i)=>r.cells[0].textContent=`${i+1}回戦`);
}

function calculate(){
  const totals=[0,0,0,0];
  tbody.querySelectorAll("tr").forEach(r=>{
    r.querySelectorAll("input").forEach((i,idx)=>totals[idx]+=Number(i.value)||0);
  });
  totals.forEach((v,i)=>document.getElementById("total"+i).textContent=v);
  [...totals].map((v,i)=>({v,i})).sort((a,b)=>b.v-a.v)
    .forEach((o,r)=>document.getElementById("rank"+o.i).textContent=r+1);
  saveData();
}

function saveData(){
  localStorage.setItem(STORAGE_KEY,JSON.stringify({
    names:[...document.querySelectorAll("select.player")].map(s=>s.value),
    rounds:[...tbody.rows].map(r=>[...r.querySelectorAll("input")].map(i=>i.value))
  }));
}

function loadData(){
  initPlayerSelects();
  const d=JSON.parse(localStorage.getItem(STORAGE_KEY));
  if(!d){addRound();return;}
  document.querySelectorAll("select.player").forEach((s,i)=>s.value=d.names[i]||"");
  d.rounds.forEach(r=>addRound(r));
}

function saveGameResult(){
  const history=JSON.parse(localStorage.getItem(HISTORY_KEY))||[];
  history.unshift({
    date:new Date().toLocaleString(),
    names:[...document.querySelectorAll("select.player")].map(s=>s.value),
    totals:[0,1,2,3].map(i=>document.getElementById("total"+i).textContent),
    ranks:[0,1,2,3].map(i=>document.getElementById("rank"+i).textContent)
  });
  localStorage.setItem(HISTORY_KEY,JSON.stringify(history));
  alert("保存しました");
}

function renderHistory(){
  const body=document.getElementById("historyBody");
  body.innerHTML="";
  const history=JSON.parse(localStorage.getItem(HISTORY_KEY))||[];
  history.forEach((h,i)=>{
    body.innerHTML+=`
<tr>
<td>${h.date}</td>
<td>${h.names.join(",")}</td>
<td>${h.totals.join(",")}</td>
<td>${h.ranks.join(",")}</td>
<td>
<button onclick="editHistoryDate(${i})">日付</button>
<button onclick="deleteHistory(${i})">削除</button>
</td>
</tr>`;
  });
}

function editHistoryDate(i){
  const h=JSON.parse(localStorage.getItem(HISTORY_KEY))||[];
  const d=prompt("日時を修正",h[i].date);
  if(d===null)return;
  h[i].date=d;
  localStorage.setItem(HISTORY_KEY,JSON.stringify(h));
  renderHistory();
}

function deleteHistory(i){
  if(!confirm("削除しますか？"))return;
  const h=JSON.parse(localStorage.getItem(HISTORY_KEY))||[];
  h.splice(i,1);
  localStorage.setItem(HISTORY_KEY,JSON.stringify(h));
  renderHistory();
}

function exportCSV(){
  const h=JSON.parse(localStorage.getItem(HISTORY_KEY))||[];
  let csv="日時,プレイヤー,合計,順位\n";
  h.forEach(r=>{
    csv+=`${r.date},"${r.names.join("/")}","${r.totals.join("/")}","${r.ranks.join("/")}"\n`;
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="mahjong_history.csv";
  a.click();
}

function toggleHistory(){
  const a=document.getElementById("historyArea");
  const t=document.getElementById("scoreTable");
  const b=document.getElementById("actionBar");
  if(a.style.display==="none"||a.style.display===""){
    renderHistory();a.style.display="block";t.style.display="none";b.style.display="none";a.classList.add("fullscreen");
  }else{
    a.style.display="none";t.style.display="";b.style.display="";a.classList.remove("fullscreen");
  }
}

// 修正版リセット：履歴は消さずにゲーム中のスコアだけリセット
function resetData(){
  if(confirm("現在のゲームデータをリセットしますか？\n※履歴は消えません")){
    localStorage.removeItem(STORAGE_KEY); // ゲーム中データだけ削除
    location.reload();
  }
}

loadData();
</script>
</body>
</html>
